<!DOCTYPE html>
<html>

<head>
    <script src="http://localhost:1337/framecode"></script>

    <style>
        html {

            width: 100%;
            height: 100%;
        }

        body {

            width: 100%;
            height: 100%;
        }

        #wrap {
            width: 100%;
            height: 100%;
            border: 1px solid #ccc;
        }

        canvas {
            display: block;
            /* removes tiny baseline gap */
            width: 100%;
            height: 100%;
        }
    </style>


    <script>
        window.onload = function () {
            start();
        };

    </script>




</head>

<body style="background-color:powderblue;">



    <div id="wrap">
        <canvas id="c"></canvas>
    </div>





    <script>

        let mouseX = 0;
        let mouseY = 0;


        function start() {
            console.log("start");

            frameMessaging.onHostMessage = onHostMessage;
            frameMessaging.init();


            // test example
            document.addEventListener("mousemove", (event) => {
                mouseX = event.clientX;
                mouseY = event.clientY;

                  var data = {
                    mouseX: mouseX,
                    mouseY: mouseY
                };
                frameMessaging.sendFrameMessage(data);
            });

            // startMousePosUpdate();
        }


        function onHostMessage(msg) {
            // console.log("onHostMessage-->" + JSON.stringify(msg));
            var type = msg.type;
            // console.log(type);
            if (type == "SOCKET_MESSAGE") {
                // var users = msg.data.users;
                // clearDots();

                Object.values(msg.data.users).forEach(user => {
                    if (user.data != null) {
                        var mx = user.data.mouseX;
                        var my = user.data.mouseY;
                        // console.log(user.wsUUID);


                        drawDot(mx, my, 5, colorFromUUID(user.wsUUID));
                    }

                });



                // var nUsers = msg.data.connectedUsers;
                // console.log(nUsers);
                //document.getElementById("nusers").innerHTML = "Connected users: " + nUsers;
            }

        }




        // function startMousePosUpdate() {
        //     setInterval(() => {

        //         var data = {
        //             mouseX: mouseX,
        //             mouseY: mouseY
        //         };
        //         frameMessaging.sendFrameMessage(data);


        //     }, 10);
        // }



        ///// canvas test

        const canvas = document.getElementById("c");
        const ctx = canvas.getContext("2d");

        function resizeCanvasToDisplaySize() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = Math.round(rect.width * dpr);
            canvas.height = Math.round(rect.height * dpr);
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // draw using CSS pixels
        }

        function drawDot(x, y, r = 4, color = "red") {
            ctx.beginPath();
            ctx.fillStyle = color;
            ctx.arc(x, y, r, 0, Math.PI * 2);
            ctx.fill();
        }
        function clearDots() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // init
        resizeCanvasToDisplaySize();
        // drawDot(100, 80);




        // // click to draw at mouse position
        // canvas.addEventListener("click", (e) => {
        //     const rect = canvas.getBoundingClientRect();
        //     const x = e.clientX - rect.left;
        //     const y = e.clientY - rect.top;
        //     drawDot(x, y);
        // });

        function colorFromUUID(uuid) {
            let hash = 0;

            for (let i = 0; i < uuid.length; i++) {
                hash = uuid.charCodeAt(i) + ((hash << 5) - hash);
                hash |= 0; // force 32-bit
            }

            const hue = Math.abs(hash) % 360;
            return `hsl(${hue}, 70%, 50%)`;
        }

        window.addEventListener("resize", () => {
            resizeCanvasToDisplaySize();
        });

    </script>
</body>

</html>